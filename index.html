const SHEET_NAME = 'Produtos';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['ID','Data','Nome','Categoria','Emoji','Descrição',
        'Min Bordado','Min Costura','Min Acabamento','Linhas','Custo Linha',
        'Custo Materiais','Embalagem','Frete','Taxa Mkt','Desconto%','Unidades',
        'Custo Unit','Margem%','Preço Final']);
      sheet.getRange(1,1,1,20).setFontWeight('bold')
        .setBackground('#B5614A').setFontColor('white');
    }
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      const ids = sheet.getRange(2,1,lastRow-1,1).getValues();
      for (let i = ids.length-1; i >= 0; i--) {
        if (String(ids[i][0]) === String(data.id)) {
          sheet.deleteRow(i+2); break;
        }
      }
    }
    // If __delete flag, removal already done above — just return success
    if (data.__delete) {
      return ContentService
        .createTextOutput(JSON.stringify({success: true}))
        .setMimeType(ContentService.MimeType.JSON);
    }
    sheet.appendRow([
      data.id, data.data, data.nome, data.cat, data.emoji, data.desc,
      data.min_bord, data.min_cos, data.min_acab,
      data.linhas, data.linha_val, data.matCusto, data.embalagem,
      data.frete, data.mkt_taxa, data.desconto, data.unid,
      data.custo, data.margem, data.preco
    ]);
    return ContentService
      .createTextOutput(JSON.stringify({success: true}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const sheet = ss.getSheetByName(SHEET_NAME);
    let produtos = [];
    if (sheet && sheet.getLastRow() > 1) {
      const rows = sheet.getRange(2, 1, sheet.getLastRow()-1, 20).getValues();
      produtos = rows.filter(r => r[0]).map(r => ({
        id: r[0], data: r[1], nome: r[2], cat: r[3], emoji: r[4], desc: r[5],
        min_bord: r[6], min_cos: r[7], min_acab: r[8],
        linhas: r[9], linha_val: r[10], matCusto: r[11], embalagem: r[12],
        frete: r[13], mkt_taxa: r[14], desconto: r[15], unid: r[16],
        custo: r[17], margem: r[18], preco: r[19]
      }));
    }
    const result = JSON.stringify({success: true, produtos: produtos});
    // Support JSONP for cross-origin requests
    const callback = e && e.parameter && e.parameter.callback;
    if (callback) {
      return ContentService
        .createTextOutput(callback + '(' + result + ')')
        .setMimeType(ContentService.MimeType.JAVASCRIPT);
    }
    return ContentService
      .createTextOutput(result)
      .setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService
      .createTextOutput(JSON.stringify({success: false, error: err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
